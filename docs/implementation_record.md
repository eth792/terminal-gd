# OCR Match Core å®æ–½è®°å½•

æœ¬æ–‡æ¡£è®°å½• ocr-match-core çš„ç‰ˆæœ¬è¿­ä»£å’Œå…³é”®æ”¹è¿›ã€‚

## ç‰ˆæœ¬å†å²

### v0.1.4 - P0-Fix: é«˜ç½®ä¿¡åº¦æ—è·¯ (2025-11-13)

**å®æ–½å†…å®¹**:
- ä¿®å¤åˆ†æ¡¶é€»è¾‘è®¾è®¡ç¼ºé™·ï¼ˆé«˜ç½®ä¿¡åº¦æ—è·¯ï¼‰
- è§£å†³ P0-2 æ— æ•ˆçš„æ ¹æœ¬åŸå› 
- å®ç°è‡ªåŠ¨é€šè¿‡ç‡ **3.6% â†’ 27.5%** (**7.6å€æå‡**)

#### ä»£ç å˜æ›´

**1. ä¿®å¤ `bucketize.ts` åˆ†æ¡¶é€»è¾‘** (`packages/ocr-match-core/src/bucket/bucketize.ts:57-61`)

æ–°å¢è§„åˆ™4ï¼ˆé«˜ç½®ä¿¡åº¦æ—è·¯ï¼‰ï¼Œåœ¨ delta æ£€æŸ¥ä¹‹å‰æ‹¦æˆªé«˜è´¨é‡åŒ¹é…ï¼š

```typescript
// è§„åˆ™4: é«˜ç½®ä¿¡åº¦æ—è·¯ - æé«˜åˆ†æ•°ç›´æ¥é€šè¿‡ï¼Œå¿½ç•¥ delta
// ä¿®å¤è®¾è®¡ç¼ºé™·ï¼šé¿å…é«˜è´¨é‡åŒ¹é…è¢« delta æ£€æŸ¥è¯¯åˆ¤ä¸º review
if (top1.score >= 0.90 && top1.f1_score >= 0.80 && top1.f2_score >= 0.80) {
  return { bucket: 'exact', reason: null };
}

// è§„åˆ™5: Top1-Top2 å·®å€¼è¿‡å° â†’ review
if (delta < config.minDeltaTop) {
  return { bucket: 'review', reason: FailReason.DELTA_TOO_SMALL };
}
```

**è®¾è®¡ç¼ºé™·è¯´æ˜**:
- åŸé€»è¾‘ï¼šRule 4 (delta check) åœ¨ Rule 5 (autoPass check) ä¹‹å‰ï¼Œæå‰è¿”å›
- åæœï¼šDELTA_TOO_SMALL æ¡ˆä¾‹æ°¸è¿œæ— æ³•è¢« autoPass æ•‘å›
- ä¿®å¤ï¼šåœ¨ delta æ£€æŸ¥å‰å¢åŠ é«˜ç½®ä¿¡åº¦æ—è·¯ï¼Œç›´æ¥é€šè¿‡é«˜åˆ†æ¡ˆä¾‹

#### æµ‹è¯•ç»“æœ

| ç‰ˆæœ¬ | Exact | Review | Fail | è‡ªåŠ¨é€šè¿‡ç‡ | è¿è¡Œ ID |
|------|-------|--------|------|------------|---------||
| P0-1 Bugfix | 8 (3.6%) | 80 (36.0%) | 134 (60.4%) | 3.6% | `run_p0_1_bugfix_20251113_011205` |
| **P0-Fix** | **61 (27.5%)** | 27 (12.2%) | 134 (60.4%) | **27.5%** | `run_p0_fix_20251113_093559` |

**æ”¹å–„æ•ˆæœ**:
- âœ… **53 ä¸ªé«˜è´¨é‡åŒ¹é…è¢«æ•‘å›** (review â†’ exact)
- âœ… **è‡ªåŠ¨é€šè¿‡ç‡**: 3.6% â†’ **27.5%** (**+23.9%**, **7.6å€**)
- âœ… **DELTA_TOO_SMALL**: 80 â†’ 27 (-53 ä¸ª)
- âœ… è¶…å‡ºé¢„æœŸï¼šé¢„æœŸ 12-16%ï¼Œå®é™… **27.5%**

#### ç›¸å…³æ–‡æ¡£

- **å®Œæ•´æŠ¥å‘Š**: `analysis/P0_fix_report_20251113.md`
- **è¿è¡ŒåŒ…**: `runs/run_p0_fix_20251113_093559/`

#### æŠ€æœ¯æ´å¯Ÿ

**ä¸ºä»€ä¹ˆ P0-2 (é™ä½ minDeltaTop) å®Œå…¨æ— æ•ˆï¼Ÿ**
- åŸè§„åˆ™é¡ºåºï¼šdelta æ£€æŸ¥åœ¨ autoPass æ£€æŸ¥ä¹‹å‰
- å³ä½¿é™ä½ minDeltaTop é˜ˆå€¼ï¼Œé«˜åˆ†æ¡ˆä¾‹ä»è¢« delta æ£€æŸ¥æå‰æ‹¦æˆª
- éœ€è¦ä»£ç çº§ä¿®å¤ï¼Œè€Œä¸æ˜¯å‚æ•°è°ƒæ•´

**é«˜ç½®ä¿¡åº¦æ—è·¯çš„è®¾è®¡ç†å¿µ**:
- **åˆ†æ•° >= 0.90**: ç»¼åˆç›¸ä¼¼åº¦æé«˜
- **å­—æ®µåˆ† >= 0.80**: å•å­—æ®µåŒ¹é…å¯é 
- **é€»è¾‘**: åŒæ—¶æ»¡è¶³è¿™äº›æ¡ä»¶çš„åŒ¹é…ï¼Œå³ä½¿ Top1-Top2 å·®å€¼å°ï¼Œä¹Ÿåº”ç›´æ¥é€šè¿‡
- **æ”¶ç›Š**: æ•‘å› 53 ä¸ªé«˜è´¨é‡åŒ¹é…ï¼Œè‡ªåŠ¨é€šè¿‡ç‡æå‡ 7.6 å€

---

### v0.1.3 - P0 ä¼˜åŒ–ï¼šæ ‡ç‚¹ç¬¦å·å½’ä¸€åŒ– (2025-11-13)

**å®æ–½å†…å®¹**:
- **P0-1**: æ ‡ç‚¹ç¬¦å·å½’ä¸€åŒ– (Normalizer æ¨¡å¼)
- **P0-1 Bugfix**: ä¿®å¤åå¤„ç†æ¸…æ´—çš„åŠè§’å†’å·æ”¯æŒ
- **P0-2**: å°è¯•é™ä½ minDeltaTop é˜ˆå€¼ (å‘ç°è®¾è®¡ç¼ºé™·)

#### ä»£ç å˜æ›´

**1. å¼•å…¥ Normalizer å‡½æ•°æ¨¡å¼** (`packages/ocr-match-core/src/match/`)

åœ¨ç›¸ä¼¼åº¦è®¡ç®—å‰ç»Ÿä¸€åº”ç”¨æ ‡ç‚¹ç¬¦å·å½’ä¸€åŒ–ï¼š

- `similarity.ts`: æ·»åŠ  `Normalizer` ç±»å‹å’Œå¯é€‰ normalizer å‚æ•°
  ```typescript
  export type Normalizer = (text: string) => string;

  export function levenshteinSimilarity(
    s1: string,
    s2: string,
    normalizer?: Normalizer
  ): number
  ```

- `rank.ts`: åœ¨å€™é€‰æ‰“åˆ†æ—¶åº”ç”¨ normalizer
- `strategies.ts`: åœ¨ä¸‰ç§åŒ¹é…ç­–ç•¥ä¸­ä¼ é€’ normalizer
- `match.ts`: åˆ›å»º normalizer é—­åŒ…
  ```typescript
  const normalizer = (text: string) => normalize(text, config.normalize);
  const matchResult = match(cleaned.supplier, cleaned.project, index, 0.6, 3, normalizer);
  ```

**2. ä¿®å¤åå¤„ç†æ¸…æ´— bug** (`match.ts:98-108`)

æ”¯æŒå…¨è§’å’ŒåŠè§’å†’å·çš„ admin prefix æ¸…æ´—ï¼š
```typescript
const adminPrefixes = [
  'é¡¹ç›®ç®¡ç†å•ä½ï¼šå®¢æˆ·æœåŠ¡ä¸­å¿ƒå¸‚åœºåŠå¤§å®¢æˆ·æœåŠ¡å®¤',
  'é¡¹ç›®ç®¡ç†å•ä½:å®¢æˆ·æœåŠ¡ä¸­å¿ƒå¸‚åœºåŠå¤§å®¢æˆ·æœåŠ¡å®¤',  // åŠè§’ç‰ˆæœ¬
  'é¡¹ç›®ç®¡ç†å•ä½ï¼šè¿ç»´æ£€ä¿®éƒ¨å·¥ç¨‹åç§°ï¼š',
  'é¡¹ç›®ç®¡ç†å•ä½:è¿ç»´æ£€ä¿®éƒ¨å·¥ç¨‹åç§°:',              // åŠè§’ç‰ˆæœ¬
  // ...
];
```

**3. é…ç½®ç‰ˆæœ¬æ›´æ–°**

æ–°å»ºé…ç½®ç‰ˆæœ¬ `configs/v0.labs/958582ab/`:
- `normalize.user.json`: æ–°å¢ 9 ä¸ªæ ‡ç‚¹ç¬¦å·å½’ä¸€åŒ–è§„åˆ™
  - `ï¼š` â†’ `:`
  - `ï¼›` â†’ `;`
  - `ï¼ˆ` â†’ `(`
  - `ï¼‰` â†’ `)`
  - `ã€` â†’ `[`
  - `ã€‘` â†’ `]`
  - `"` â†’ `"`
  - `"` â†’ `"`
  - `ã€Šã€‹` â†’ `<>`

#### æµ‹è¯•ç»“æœ

| ç‰ˆæœ¬ | Exact | Review | Fail | è‡ªåŠ¨é€šè¿‡ç‡ | è¿è¡Œ ID |
|------|-------|--------|------|------------|---------|
| Baseline | 8 (3.6%) | 79 (35.6%) | 135 (60.8%) | 3.6% | `run_postprocess_20251112_231036` |
| P0-1 Bugfix | 8 (3.6%) | 80 (36.0%) | 134 (60.4%) | 3.6% | `run_p0_1_bugfix_20251113_011205` |
| P0-2 | 8 (3.6%) | 80 (36.0%) | 134 (60.4%) | 3.6% | `run_p0_2_20251113_024120` |

**P0-1 æ•ˆæœåˆ†æ**:
- âœ… 47 ä¸ªæ–‡ä»¶åˆ†æ•°æ”¹å–„ï¼Œå¹³å‡æå‡ +0.9%
- âœ… 1 ä¸ªæ–‡ä»¶ä» fail â†’ review
- âœ… 3 ä¸ªæ–‡ä»¶è¾¾åˆ°å®Œç¾åŒ¹é… (score = 1.0000)
- âœ… ä¿®å¤äº† 6 ä¸ªåå¤„ç†æ¸…æ´—å›å½’æ¡ˆä¾‹
- âŒ è‡ªåŠ¨é€šè¿‡ç‡æ— æ”¹å–„ (æœªè¾¾æ¡¶ä½è·ƒè¿é˜ˆå€¼)

**P0-2 å¤±æ•ˆåŸå› **:
- âŒ å®Œå…¨æ— æ•ˆï¼Œç»“æœä¸ P0-1 bugfix å®Œå…¨ç›¸åŒ
- ğŸ› **å‘ç°è®¾è®¡ç¼ºé™·**: `bucketize.ts:57-76` è§„åˆ™é¡ºåºé”™è¯¯
  - Rule 4 (delta check) æå‰è¿”å›ï¼Œé˜»æ­¢ Rule 5 (autoPass check) æ‰§è¡Œ
  - å¯¼è‡´ minDeltaTop å‚æ•°è°ƒæ•´æ— æ³•å°† DELTA_TOO_SMALL æ¡ˆä¾‹è½¬ä¸º exact
  - **å½±å“èŒƒå›´**: 80 ä¸ª DELTA_TOO_SMALL æ¡ˆä¾‹ (36.0%)ï¼Œå…¶ä¸­ 28 ä¸ª Top1 >= 0.95

#### ç›¸å…³æ–‡æ¡£

- **å®Œæ•´æŠ¥å‘Š**: `runs/P0_optimization_report_20251113.md`
- **å¤±è´¥åˆ†æ**: `analysis/failure_analysis_report.md`
- **ä¼˜åŒ–è·¯çº¿å›¾**: `analysis/optimization_roadmap.md`

#### ä¸‹ä¸€æ­¥è®¡åˆ’

**å¾…ä¿®å¤**: åˆ†æ¡¶é€»è¾‘è®¾è®¡ç¼ºé™·
- **Option 1**: è°ƒæ•´è§„åˆ™é¡ºåº (å…ˆ autoPassï¼Œå† delta)
- **Option 2**: é«˜ç½®ä¿¡åº¦æ—è·¯ (æ¨è)
  ```typescript
  if (top1.score >= 0.90 && top1.f1_score >= 0.80 && top1.f2_score >= 0.80) {
    return { bucket: 'exact', reason: null };
  }
  ```

**é¢„æœŸæ”¹å–„**: ä¿®å¤åè‡ªåŠ¨é€šè¿‡ç‡ **3.6% â†’ 12-16%** (3-4å€æå‡)

---

### v0.1.2 - å¤šæ–‡ä»¶ DB ç´¢å¼•æ”¯æŒ (2025-11-12)

**å®æ–½å†…å®¹**:
- æ”¯æŒå¤šä¸ª Excel æ–‡ä»¶ä½œä¸º DB è¾“å…¥
- è‡ªåŠ¨åˆå¹¶åˆ—ç»“æ„ï¼ˆå– unionï¼‰
- ç”Ÿæˆç»Ÿä¸€çš„ DB digest

**ä»£ç å˜æ›´**:
- `build-index.ts`: æ”¯æŒ `--db` æŒ‡å‘ç›®å½•æˆ–æ–‡ä»¶
- `manifest.json`: è®°å½• DB fingerprints

**æµ‹è¯•ç»“æœ**:
- âœ… æˆåŠŸåˆå¹¶ `ledger-1.xlsx` å’Œ `ledger-2.xlsx`
- âœ… æ€»è¡Œæ•°ï¼š178,043
- âœ… å”¯ä¸€ supplierï¼š517 ä¸ª
- âœ… å€’æ’è¯æ¡ï¼š13,848 ä¸ª

---

### v0.1.1 - åå¤„ç†å­—æ®µæ¸…æ´— (2025-11-11)

**å®æ–½å†…å®¹**:
- å®ç°åå¤„ç† admin prefix æ¸…æ´—
- æ·»åŠ  `was_cleaned` æ ‡è®°åˆ° `results.csv`

**ä»£ç å˜æ›´**:
- `match.ts`: æ·»åŠ  adminPrefixes æ£€æµ‹å’Œæ¸…æ´—é€»è¾‘
- `results.csv`: æ–°å¢ `was_cleaned` åˆ—

**æµ‹è¯•ç»“æœ**:
- âœ… 29 ä¸ªæ–‡ä»¶è¢«æ¸…æ´—
- âœ… å¹³å‡åˆ†æ•°æå‡ +5.2%
- âœ… 7 ä¸ªæ–‡ä»¶æ¡¶ä½æ”¹å–„

---

### v0.1.0 - æ ¸å¿ƒæµç¨‹å®ç° (2025-11-10)

**å®æ–½å†…å®¹**:
- å®Œæˆå››é˜¶æ®µå¤„ç†ç®¡çº¿ï¼ˆnormalize â†’ extract â†’ match â†’ bucketizeï¼‰
- å®ç°ä¸‰çº§åŒ¹é…ç­–ç•¥ï¼ˆfast-exact â†’ anchor â†’ recall+rankï¼‰
- ç”Ÿæˆè¿è¡ŒåŒ…ç»“æ„ï¼ˆmanifest.json / results.csv / summary.md / log.jsonlï¼‰

**ä»£ç å˜æ›´**:
- `normalize/pipeline.ts`: æ–‡æœ¬å½’ä¸€åŒ–
- `extract/extractor.ts`: å­—æ®µæå–
- `match/strategies.ts`: åŒ¹é…ç­–ç•¥
- `bucket/bucketize.ts`: åˆ†æ¡¶é€»è¾‘
- `report/generator.ts`: æŠ¥å‘Šç”Ÿæˆ

**æµ‹è¯•ç»“æœ**:
- âœ… åŸºç¡€æµç¨‹æ‰“é€š
- âœ… Baseline è‡ªåŠ¨é€šè¿‡ç‡ï¼š3.6%
- âœ… å¹³å‡è€—æ—¶ï¼š8.3s/æ–‡ä»¶

---

## å…³é”®æŒ‡æ ‡æ¼”è¿›

| ç‰ˆæœ¬ | è‡ªåŠ¨é€šè¿‡ç‡ | å¹³å‡åˆ†æ•° | å¹³å‡è€—æ—¶ | é…ç½®ç‰ˆæœ¬ |
|------|-----------|---------|---------|---------|
| v0.1.0 | 3.6% | 0.6421 | 8.3s | v0.base |
| v0.1.1 | 3.6% | 0.6690 (+4.2%) | 8.3s | v0.postprocess |
| v0.1.2 | 3.6% | 0.6690 | 8.3s | v0.postprocess |
| v0.1.3 | 3.6% | 0.6751 (+0.9%) | 8.3s | v0.labs/958582ab |
| **v0.1.4** | **27.5% (+663%)** | 0.6751 | 9.7s | v0.labs/958582ab |

**é‡å¤§çªç ´**: v0.1.4 ä¿®å¤åˆ†æ¡¶é€»è¾‘ï¼Œè‡ªåŠ¨é€šè¿‡ç‡æå‡ **7.6 å€**ï¼

---

## æŠ€æœ¯å€ºåŠ¡

### High

1. **ç¼ºå°‘ results_top3.csv**
   - å½±å“ï¼šæ— æ³•åˆ†æ Top3 å€™é€‰åˆ†æ•°åˆ†å¸ƒ
   - ä¿®å¤æ–¹æ¡ˆï¼šåœ¨ `report/generator.ts` ä¸­æ·»åŠ  Top3 è¾“å‡º
   - ä¼˜å…ˆçº§ï¼šP1

2. **ç¼ºå°‘ review.html å•é¡µå®¡æŸ¥å™¨**
   - å½±å“ï¼šæ— æ³•å¿«é€Ÿäººå·¥å®¡æ ¸
   - ä¿®å¤æ–¹æ¡ˆï¼šå®ç°å‰ç«¯å•é¡µåº”ç”¨
   - ä¼˜å…ˆçº§ï¼šP1

---

**æœ€åæ›´æ–°**: 2025-11-13 10:15
