# v0.1.6 待修复问题清单

**创建日期**: 2025-11-13
**发现来源**: v0.1.5 运行包 `run_v0.1.5_fix_20251113_133741` 的 SUPPLIER_DIFF_SAME_PROJECT 案例人工审核

---

## 📋 问题总览

| 问题 ID | 优先级 | 类型 | 预期影响 | 状态 |
|---------|--------|------|----------|------|
| Issue-1 | **P0** | 匹配失误 | 1个案例 | 🔍 调查中 |
| Issue-2 | **P1** | OCR 归一化 | 1-3个案例 | 📝 待实施 |
| Issue-3 | **P2** | 流程优化 | 质量改善 | 💭 设计中 |
| Issue-4 | **P1** | 报告优化 | 体验改善 | 📝 待实施 |

---

## 🔥 Issue-1: 匹配失误案例（P0 - 高优先级）

### 问题描述

**案例文件**: `baohuixianlanjituan4100965990.txt`

**现象**:
- ✅ **提取正确**：供应商 = "宝辉线缆集团有限公司"
- ✅ **提取正确**：项目 = "武汉三镇中心置业有限公司"新建商业、商务、居住、防护绿色项目"新配套工租"
  - ⚠️ 注意："工租" 是 OCR 错误，应为"工程"
- ❌ **匹配错误**：Top1 候选是完全错误的供应商

**期望结果**:
- 应匹配到 `ledger-1.xlsx` 的正确行（待验证具体行号）
- 供应商应为："宝辉线缆集团有限公司"

**实际结果**:
```
cand_f1: "泰亿达科技集团有限公司" ❌ (完全错误)
cand_f2: "武汉三镇中心置业有限公司"新建商业、商务、居住、防护绿色项目"新配套工程"
source_file: ledger-1.xlsx
row_index: 1376

f1_score: 0.4512 (勉强达到 Rule 3.5 的 0.40 下界)
f2_score: 0.8309 (超过 0.80 阈值)
bucket: review
reason: SUPPLIER_DIFF_SAME_PROJECT
```

### 根因分析（待确认）

**可能原因 1**: 倒排索引召回失败
- "宝辉线缆集团" 的 n-gram 没有正确召回包含正确供应商的候选
- 需要检查：正确答案是否在召回的 5000 个候选中

**可能原因 2**: 相似度计算问题
- 正确答案的综合分数被错误候选挤掉
- 需要检查：正确答案的 score/f1_score/f2_score 分别是多少

**可能原因 3**: TopK 截断问题
- 正确答案在排序后被截断（只保留 Top3）
- 需要检查：正确答案排在第几名

### 调试计划

1. **验证 DB 中是否存在正确答案**
   ```bash
   # 在 ledger-1.xlsx 中搜索"宝辉线缆集团有限公司"
   # 确认行号和完整内容
   ```

2. **打印该案例的 Top10 候选**
   ```bash
   # 修改代码临时输出 Top10（不是 Top3）
   # 查看正确答案是否在其中
   ```

3. **检查倒排索引**
   ```bash
   # 检查"宝辉"/"线缆"/"集团"的 n-gram 是否正确建立
   # 查看倒排表中包含这些词的行数
   ```

4. **分析召回和排序**
   - 如果正确答案在召回中但排序靠后 → 相似度计算问题
   - 如果正确答案不在召回中 → 倒排索引或 n-gram 问题

### 预期收益

**如果修复成功**:
- 直接救回 1 个案例（fail/review → exact）
- 间接影响：可能发现类似的系统性问题，救回更多案例

---

## 🔧 Issue-2: OCR 错误归一化（P1 - 中优先级）

### 问题描述

**OCR 错误**: "工程" → "工理"

**已确认案例**:
1. `baoshengkejichuangxingufenyouxiangongsi4100931561.txt`
   ```
   原文：S1块建设项且"新住配工理
   应为：S1块建设项且"新住配工程
   ```

**潜在影响**:
- 可能有 1-3 个类似案例
- 导致项目字段提取错误或相似度降低

### 修复方案

**配置文件**: 新建配置版本（如 `configs/v0.labs/<new_sha>/`）

**新增规则**:
```json
{
  "replacements": [
    {
      "match": "工理",
      "replace": "工程",
      "description": "OCR错误：理→程（形似字混淆）"
    }
  ]
}
```

**实施步骤**:
1. 创建新配置版本目录
2. 复制现有配置 + 新增规则
3. 更新 `configs/latest.json` 指向新版本
4. 重新构建索引 + 运行测试

### 预期收益

**保守估计**: 救回 1-2 个案例
**乐观估计**: 救回 3-5 个案例（如果存在更多"工理"错误）

---

## 📊 Issue-3: DB 缺失记录机制（P2 - 低优先级）

### 问题描述

**用户需求**:
> "假设输入源确实在目前的 DB 每个 xlsx 中都找不到，应该记录下来，待 DB 补充后再进行"

**现状问题**:
- 无法区分"召回失败"和"DB 真正缺失"
- 无法追踪哪些样本需要补充到 DB

**案例**:
- SUPPLIER_DIFF_SAME_PROJECT 的 7 个案例中，有 6 个可能是 DB 缺失（待人工确认）

### 设计方案（待讨论）

**方案 A**: 新增 FailReason - `NO_CANDIDATES_DB_MISSING`
- **触发条件**: 召回候选数 = 0（完全没有匹配）
- **人工审核流程**:
  1. 系统标记为 `NO_CANDIDATES`
  2. 人工确认 DB 中确实不存在
  3. 手动修改 `results.csv` 的 `reason` 为 `NO_CANDIDATES_DB_MISSING`
  4. 导出 DB 补充清单

**方案 B**: 运行包新增 `db_missing.csv` 输出
- 记录所有 `NO_CANDIDATES` 案例
- 包含提取的字段、OCR 源文件路径
- 供 DB 管理员审核和补充

**方案 C**: 延迟决策
- 先完成 Issue-1 和 Issue-2
- 基于测试结果重新评估需求

### Linus 式判断

> **"This is solving a real problem, but the solution needs refinement."**
>
> 不要急于标记"DB 缺失"，因为你无法区分：
> - OCR 错误导致的召回失败（如"工理"→"工程"）
> - 归一化不足导致的召回失败（如"保辉"vs"宝辉"）
> - DB 真正缺失
>
> **先修复 Issue-1 和 Issue-2，再看还有多少"找不到"案例。**

### 实施建议

**推荐方案**: 方案 C（延迟决策）
- v0.1.6 先不实施此功能
- 完成 OCR 归一化和匹配修复后
- v0.1.7 根据残留的 `NO_CANDIDATES` 案例数量决定是否实施

---

## 🎨 Issue-4: 报告目录命名优化（P1 - 低成本改进）

### 问题描述

**当前命名**: `run_v0.1.5_fix_20251113_133741` (秒级精度)
**期望命名**: `run_v0.1.5_fix_20251113_1337` (分钟级精度)

### 修复方案

**修改位置**: 所有测试脚本中的时间戳格式

**改法**:
```bash
# 当前
--out ./runs/run_v0.1.5_fix_$(date +%Y%m%d_%H%M%S)

# 改为
--out ./runs/run_v0.1.5_fix_$(date +%Y%m%d_%H%M)
```

**影响范围**:
- 测试脚本（非代码级修改）
- 不影响代码逻辑
- 不需要重新构建

### Linus 式评价

> **"Reasonable improvement. Minute-level precision is more than enough."**
>
> 秒级精度纯属过度精确，分钟级完全够用，还能让目录名更短、更易读。

### 预期收益

- ✅ 目录名更简洁（少 2 个字符）
- ✅ 人类可读性提升
- ✅ 不影响任何功能

---

## 📈 优先级排序

### 立即执行（v0.1.6 必须完成）

1. **Issue-1**: 匹配失误案例调试 ⚡
2. **Issue-2**: OCR 归一化补充 ⚡
3. **Issue-4**: 目录命名优化 ⚡

### 延期评估（v0.1.7 考虑）

4. **Issue-3**: DB 缺失记录机制 ⏸️

---

## 🎯 预期成果（v0.1.6）

### KPI 目标

| 指标 | v0.1.5 基线 | v0.1.6 目标 | 提升幅度 |
|------|-------------|-------------|----------|
| **自动通过率** | 31.5% | **34-36%** | +2.5-4.5% |
| Exact | 70 | 75-80 | +5-10 |
| Review | 25 | 30-35 | +5-10 |
| Fail | 127 | 110-115 | -12-17 |

### 预期收益拆解

- **Issue-1 修复**: +1 案例（如果成功）
- **Issue-2 归一化**: +1-3 案例
- **原计划 P2 优化**: +15-20 案例（Rule 3.5 调整 + 其他优化）
- **合计**: +17-24 案例（乐观估计）

---

**最后更新**: 2025-11-13
**负责人**: Claude Code (Linus Mode)
**下次复审**: v0.1.6 实施计划完成后
