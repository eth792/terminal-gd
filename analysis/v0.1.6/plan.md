# v0.1.6 实施计划 - P2 优化 + 关键修复

**创建日期**: 2025-11-13
**计划版本**: v1.0
**状态**: 🔥 进行中
**负责人**: Claude Code (Linus Mode)

---

## 📊 版本概览

### 版本定位

v0.1.6 = **P2 优化（原计划）+ 关键修复（新增）**

- ✅ 延续 v0.1.5 的优化路线（Rule 3.5 调整）
- 🆕 修复 v0.1.5 发现的关键问题（匹配失误 + OCR 归一化）
- 🎯 提升自动通过率至 34-36%（vs v0.1.5 的 31.5%）

### KPI 目标

| 指标 | v0.1.5 基线 | v0.1.6 目标 | 提升幅度 | 置信度 |
|------|-------------|-------------|----------|--------|
| **自动通过率** | **31.5%** | **34-36%** | **+2.5-4.5%** | 中等 |
| Exact | 70 (31.5%) | 75-80 (33.8-36.0%) | +5-10 | 中等 |
| Review | 25 (11.3%) | 30-35 (13.5-15.8%) | +5-10 | 低 |
| Fail | 127 (57.2%) | 110-115 (49.5-51.8%) | -12-17 | 中等 |

**目标说明**:
- **保守目标**: 34% (救回 17 个案例)
- **乐观目标**: 36% (救回 24 个案例)
- **破局关键**: Rule 3.5 调整 + 匹配修复 + OCR 归一化

---

## 🗺️ 任务拆解

### Phase 1: 关键修复（P0/P1）

这些是 v0.1.5 暴露的问题，优先级高于原计划的 P2 优化。

#### Task 1.1: 匹配失误案例调试（P0）🔥

**问题**: `baohuixianlanjituan4100965990.txt` 匹配到错误供应商

**实施步骤**:
1. **验证 DB 中是否存在正确答案**
   - 在 `ledger-1.xlsx` 中搜索"宝辉线缆集团有限公司"
   - 确认行号和完整内容
   - 验证用户说的"应该在1883行"是否正确

2. **修改代码临时输出 Top10 候选**
   ```typescript
   // 位置：packages/ocr-match-core/src/match/match.ts
   // 修改：返回 Top10 而不是 Top3
   const topK = 10; // 临时改为 10
   ```

3. **重新运行该案例**
   ```bash
   # 只运行单个文件的测试
   node packages/ocr-match-core/dist/cli/match-ocr.js \
     --ocr data/ocr_txt/baohuixianlanjituan4100965990.txt \
     --index runs/tmp/index_p0_v3.json \
     --config . \
     --out runs/debug_baohui \
     --db data/db \
     --log-level debug
   ```

4. **分析 Top10 结果**
   - 正确答案是否在 Top10 中？
   - 如果在：为什么排序靠后？（相似度计算问题）
   - 如果不在：为什么召回失败？（倒排索引或 n-gram 问题）

5. **根因修复**
   - 如果是相似度权重问题 → 调整权重或归一化
   - 如果是倒排索引问题 → 修改 n-gram 策略或 stopwords
   - 如果是 OCR 错误（"工租"→"工程"）→ 见 Task 1.2

**预期收益**:
- 直接救回 1 个案例
- 发现系统性问题可能救回更多案例

**风险评估**: ⚠️ 中等
- 可能需要修改核心匹配算法
- 需要谨慎验证不破坏现有案例

---

#### Task 1.2: OCR 归一化补充（P1）✅

**问题**: "工程" 在 OCR 中显示为"工理"

**实施步骤**:

1. **创建新配置版本**
   ```bash
   # 1. 生成新 SHA
   NEW_SHA=$(echo -n "v0.1.6_ocr_fix_$(date +%s)" | shasum -a 256 | cut -c1-8)

   # 2. 创建新目录
   mkdir -p configs/v0.labs/$NEW_SHA

   # 3. 复制现有配置
   cp configs/v0.labs/958582ab/*.json configs/v0.labs/$NEW_SHA/
   ```

2. **新增 OCR 归一化规则**
   ```json
   // 位置：configs/v0.labs/<new_sha>/normalize.user.json
   {
     "replacements": [
       // ... 现有规则 ...
       {
         "match": "工理",
         "replace": "工程",
         "description": "OCR错误：理→程（形似字混淆）"
       }
     ]
   }
   ```

3. **更新 latest.json 指针**
   ```bash
   echo "{\"version\": \"v0.labs\", \"sha\": \"$NEW_SHA\"}" > configs/latest.json
   ```

4. **重新构建索引**
   ```bash
   pnpm -F ./packages/ocr-match-core ocr-core build-index \
     --db ./data/db \
     --out ./runs/tmp/index_v0.1.6.json \
     --config . \
     --log-level info
   ```

5. **验证配置生效**
   - 检查日志确认新配置已加载
   - 运行小规模测试（10个样本）
   - 确认"工理"被正确替换为"工程"

**预期收益**:
- 救回 1-3 个案例（取决于"工理"出现次数）

**风险评估**: ✅ 低
- 纯配置变更，不涉及代码修改
- 如果有问题可以回滚到旧配置

---

#### Task 1.3: 目录命名优化（P1）✅

**问题**: 运行包目录名包含秒级时间戳，过于冗长

**实施步骤**:

**无需修改代码**，只需在测试脚本中改变时间戳格式：

```bash
# 当前写法（所有测试脚本）
--out ./runs/run_v0.1.6_$(date +%Y%m%d_%H%M%S)

# 改为
--out ./runs/run_v0.1.6_$(date +%Y%m%d_%H%M)
```

**影响范围**:
- 不影响代码逻辑
- 不需要重新构建
- 仅影响手动测试命令

**预期收益**:
- 目录名更简洁（少 2 个字符）
- 人类可读性提升

**风险评估**: ✅ 零风险
- 纯命令行参数变更

---

### Phase 2: P2 优化（原计划）

延续 v0.1.5 的优化路线，调整 Rule 3.5 约束。

#### Task 2.1: 调整 Rule 3.5 约束（P1）

**问题**: v0.1.5 的 Rule 3.5 约束过严，仅捕获 7 个案例（预期 21 个）

**当前实现** (`packages/ocr-match-core/src/bucket/bucketize.ts:54-61`):
```typescript
// 规则3.5: 项目高度匹配，供应商可放宽 → review
if (top1.f2_score >= 0.80 && top1.f1_score >= 0.40 && top1.f1_score < 0.60) {
  return { bucket: 'review', reason: FailReason.SUPPLIER_DIFF_SAME_PROJECT };
}
```

**问题分析**:
- `f2_score >= 0.80` - 项目匹配度必须很高 ✅ 合理
- `f1_score >= 0.40` - 供应商匹配度不能太低 ✅ 合理
- `f1_score < 0.60` - 供应商匹配度不能太高 ⚠️ **过严**

**优化方案 A**: 放宽上界（推荐）
```typescript
// v0.1.6 优化版本
if (top1.f2_score >= 0.75 && top1.f1_score >= 0.40 && top1.f1_score < 0.65) {
  return { bucket: 'review', reason: FailReason.SUPPLIER_DIFF_SAME_PROJECT };
}
```

**变更对比**:
| 参数 | v0.1.5 | v0.1.6 (方案A) | 说明 |
|------|--------|----------------|------|
| `f2_score` | >= 0.80 | >= **0.75** | 降低 0.05（更宽松） |
| `f1_score` 下界 | >= 0.40 | >= 0.40 | 不变 |
| `f1_score` 上界 | < 0.60 | < **0.65** | 提高 0.05（更宽松） |

**优化方案 B**: 移除上界（激进，不推荐）
```typescript
// 激进版本（风险高）
if (top1.f2_score >= 0.75 && top1.f1_score >= 0.40) {
  return { bucket: 'review', reason: FailReason.SUPPLIER_DIFF_SAME_PROJECT };
}
```

**风险**: 可能捕获过多案例，导致 review 暴增（类似 v0.1.5 首次测试的 bug）

**实施步骤**:
1. 实施方案 A（放宽上下界）
2. 运行完整测试（222 样本）
3. 对比 v0.1.5 结果：
   - SUPPLIER_DIFF_SAME_PROJECT 案例数（预期从 7 增加到 15-20）
   - Exact/Review/Fail 分布变化
4. 如果方案 A 效果不佳，再考虑方案 B

**预期收益**:
- 救回 8-13 个案例（从 7 → 15-20 个 SUPPLIER_DIFF_SAME_PROJECT）

**风险评估**: ⚠️ 中等
- 可能捕获过多边界案例
- 需要测试验证不破坏现有 exact 案例

---

#### Task 2.2: 分析 FIELD_SIM_LOW_PROJECT 增加原因（P2）

**问题**: v0.1.5 中 FIELD_SIM_LOW_PROJECT 从 54 增加到 67（+13, +24.1%）

**调查步骤**:

1. **抽取新增的 13 个案例**
   ```bash
   # 对比 v0.1.4 和 v0.1.5 的 results.csv
   # 找出在 v0.1.4 中不是 FIELD_SIM_LOW_PROJECT 但在 v0.1.5 中是的案例
   ```

2. **逐案例分析**
   - 在 v0.1.4 中是什么 reason？
   - f2_score 值是否发生变化？
   - 是否被 Rule 3.5 错误拦截？

3. **根因分类**
   - 如果是规则顺序问题 → 调整规则顺序
   - 如果是阈值问题 → 调整 `minFieldSim`
   - 如果是正常降级 → 接受现状

**预期收益**:
- 救回 0-5 个案例（取决于根因）

**风险评估**: ✅ 低
- 纯调查任务，不涉及代码修改

---

### Phase 3: 可选优化（时间允许时）

#### Task 3.1: 文档类型检测（P3）

**需求**: 识别"订货通知单" vs "验收单"

**设计方案**: 延期到 v0.1.7
- 需要定义文档类型枚举
- 需要设计识别规则（关键词匹配）
- 需要在 results.csv 中新增 `doc_type` 字段

**预期收益**: 识别 6-10 个文档类型不匹配案例

**实施优先级**: ⏸️ 延期（v0.1.7）

---

#### Task 3.2: 地名/术语归一化增强（P3）

**需求**: 处理地名变体（如"武汉"vs"武汉市"）

**设计方案**: 延期到 v0.1.7
- 需要建立地名词典
- 需要设计归一化规则
- 需要测试不破坏现有匹配

**预期收益**: 提高 3-5 个边界案例的分数

**实施优先级**: ⏸️ 延期（v0.1.7）

---

## 📅 实施时间线

### 第 1 天（11-13）

**上午**:
- ✅ 创建 v0.1.6 目录结构
- ✅ 编写实施计划
- ✅ 更新 PROJECT_STATUS.md

**下午**:
- [ ] Task 1.1: 调试匹配失误案例（预计 2-3 小时）
- [ ] Task 1.2: OCR 归一化补充（预计 1 小时）

**晚上**:
- [ ] Task 1.3: 目录命名优化（预计 10 分钟）
- [ ] Task 2.1: 调整 Rule 3.5 约束（预计 1 小时）

---

### 第 2 天（11-14）

**上午**:
- [ ] 构建新索引（预计 10 分钟）
- [ ] 运行完整测试（预计 30 分钟）
- [ ] 分析测试结果（预计 1 小时）

**下午**:
- [ ] Task 2.2: 分析 FIELD_SIM_LOW_PROJECT 增加原因（预计 2 小时）
- [ ] 编写 v0.1.6 实测报告（预计 1 小时）

**晚上**:
- [ ] 更新所有文档（implementation_record.md / PROJECT_STATUS.md / CLAUDE.md）
- [ ] 创建 Git commit
- [ ] 发布 v0.1.6

---

## 🎯 成功标准

### 必须达成（P0）

- ✅ 自动通过率 >= 33%（vs v0.1.5 的 31.5%，至少提升 1.5%）
- ✅ Task 1.1 完成根因分析（无论是否救回案例）
- ✅ Task 1.2 配置已补充并生效
- ✅ 所有文档已更新

### 期望达成（P1）

- ✅ 自动通过率 >= 34%（提升 2.5%）
- ✅ Task 2.1 救回 8-13 个案例
- ✅ Task 2.2 完成根因分类

### 超预期（P2）

- ✅ 自动通过率 >= 36%（提升 4.5%）
- ✅ Task 1.1 修复后救回多个类似案例

---

## ⚠️ 风险管理

### 高风险项

1. **Task 1.1 调试失败**
   - **风险**: 无法找到匹配失误根因
   - **缓解**: 记录详细日志，即使无法修复也要明确问题
   - **回退**: 跳过此任务，继续其他优化

2. **Task 2.1 导致回归**
   - **风险**: 放宽 Rule 3.5 后 exact 案例减少
   - **缓解**: 先测试方案 A（保守），观察结果
   - **回退**: 如果 exact 下降超过 5 个，回退到 v0.1.5 的阈值

### 中风险项

3. **Task 1.2 配置错误**
   - **风险**: 新配置导致其他归一化规则失效
   - **缓解**: 小规模测试（10 样本）验证
   - **回退**: 回滚到 v0.1.5 配置（958582ab）

---

## 📝 交付物清单

### 代码变更

- [ ] `packages/ocr-match-core/src/bucket/bucketize.ts` - Rule 3.5 调整
- [ ] `configs/v0.labs/<new_sha>/normalize.user.json` - OCR 归一化补充
- [ ] `configs/latest.json` - 指向新配置版本

### 文档更新

- [ ] `analysis/v0.1.6/v0.1.6_实测报告.md` - 完整测试报告
- [ ] `analysis/v0.1.6/issues_discovery.md` - 问题记录（已完成）
- [ ] `analysis/v0.1.6/plan.md` - 本文件
- [ ] `docs/implementation_record.md` - 新增 v0.1.6 条目
- [ ] `docs/PROJECT_STATUS.md` - 更新核心指标和路线图
- [ ] `CLAUDE.md` - 更新快速状态恢复章节

### 运行产物

- [ ] `runs/run_v0.1.6_<timestamp>/` - 完整运行包
- [ ] `runs/tmp/index_v0.1.6.json` - 新索引文件

---

## 🔄 后续版本规划

### v0.1.7 (计划中)

**重点**:
- 文档类型检测
- 地名/术语归一化
- DB 缺失记录机制（如果 v0.1.6 后仍有大量 NO_CANDIDATES）

**预期时间**: 2-3 天

---

**最后更新**: 2025-11-13 15:30
**状态**: 🔥 进行中
**下一步**: Task 1.1 - 调试匹配失误案例
