# v0.1.7 Index Corruption Resolution Report

**Created**: 2025-11-14 10:47
**Status**: Resolution implemented, final verification in progress

---

## Executive Summary

After v0.1.7 catastrophic failure and code rollback, verification tests continued to show 0% auto-pass instead of expected 32% baseline. **Root cause was index.json corruption** - the index file was rebuilt with v0.1.7 code during the failed attempt, making it incompatible with rolled-back v0.1.6 code.

**Resolution**: Rebuilt index.json using v0.1.6 code with correct Chinese column mappings.

---

## Problem Discovery Timeline

### 1. Initial Rollback (2025-11-14 01:05)
- Rolled back source code: `git restore` on extractor.ts and label_alias.json
- **Mistake**: Forgot to rebuild dist/
- Verification test got same 0% results as failed v0.1.7

### 2. Rebuild and Second Verification (2025-11-14 01:20)
- Ran `pnpm -F ./packages/ocr-match-core build` to compile rolled-back source
- Started verification test
- **Result**: Still 0 exact, 221 fail (same as failed v0.1.7)

### 3. Root Cause Discovery (2025-11-14 02:25-02:35)
Compared same OCR file between v0.1.6 baseline and verification test:

**v0.1.6 Baseline (huayuanwangtong4100925688.txt)**:
```
q_supplier: "武汉华源网通电力有限公司"
cand_f1: "武汉华源网通电力有限公司" (EXACT MATCH)
mode: "anchor"
bucket: "exact" ✓
```

**Verification Test (same file, same extracted supplier!)**:
```
q_supplier: "武汉华源网通电力有限公司" (identical!)
cand_f1: "武汉华源电力有限公司武昌实业分公司" (WRONG!)
mode: "recall"
bucket: "review" ✗
```

**Key Finding**:
- Extracted values are IDENTICAL
- But matched candidates are DIFFERENT
- Matching mode changed from "anchor" to "recall"
- **Conclusion**: Problem is NOT in extraction, it's in the index!

### 4. Index Timestamp Check
```bash
ls -lh runs/tmp/index.json
# -rw-r--r--  1 Caron  staff   131M Nov 14 00:17 index.json
```

**Critical Discovery**:
- Index timestamp: Nov 14 00:17 (during v0.1.7 attempt)
- Baseline test timestamp: Nov 13 21:41 (before v0.1.7)
- **Index was rebuilt AFTER baseline test with failed v0.1.7 code!**

### 5. First Rebuild Attempt Failed (2025-11-14 02:38)
```bash
node packages/ocr-match-core/dist/cli/build-index.js \
  --db data/db --out runs/tmp/index.json --config .
```

**Error**:
```
Required columns not found in ledger-1.xlsx:
  Looking for: s_field1, s_field2
  Available columns: 计划编号, 计划行号, 创建日期, 项目属性, 支付方式,
                     合同执行单位, 报装编号, 项目定义号, 单体工程名称, 序号
                     (and 41 more)
```

**Root Cause**: build-index CLI defaults to looking for columns named "s_field1" and "s_field2", but the actual Excel files use Chinese column names.

### 6. Solution Discovery (2025-11-14 02:45)
Found correct column mapping in `docs/OCR_MATCH_CORE_IMPLEMENTATION.md`:
```json
{"supplier":"供应单位名称","project":"单体工程名称"}
```

Also discovered build-index CLI accepts `--field1` and `--field2` options to specify custom column names.

### 7. Successful Rebuild (2025-11-14 02:45)
```bash
node packages/ocr-match-core/dist/cli/build-index.js \
  --db data/db \
  --out runs/tmp/index.json \
  --config . \
  --field1 "供应单位名称" \
  --field2 "单体工程名称"
```

**Result**:
```
✅ Index built successfully!
   Rows: 178043
   Tokens: 13848  (vs corrupted index's 12650!)
   Digest: 2f000cbaea7e08cd...
```

**Key Difference**: Token count increased from 12650 to 13848 (+9.5%), indicating different normalization/tokenization logic between v0.1.6 and v0.1.7.

---

## Technical Analysis

### Why Index Corruption Happened

1. **v0.1.7 Code Changes** included modifications to extractor.ts that likely affected how text is normalized before indexing
2. **Index Rebuild During Failed Attempt**: During v0.1.7 testing, index.json was rebuilt to test the new code
3. **Normalization Mismatch**: v0.1.7's normalization logic created different tokens (12650) than v0.1.6 would create (13848)
4. **Matching Incompatibility**: When v0.1.6 matching code tries to use v0.1.7's index:
   - Query text is normalized with v0.1.6 rules → produces certain n-grams
   - Index was built with v0.1.7 rules → has different n-grams
   - n-gram recall fails → falls back to less precise "recall" mode instead of "anchor" mode
   - Wrong candidates returned

### Visual Representation

```
v0.1.6 Baseline (WORKS):
    OCR → v0.1.6 Extract → v0.1.6 Normalize → Query Tokens
                                                    ↓
    DB → v0.1.6 Index Builder → v0.1.6 Normalize → Index Tokens
                                                    ↓
                                            n-gram Match ✓

After v0.1.7 Attempt (BROKEN):
    OCR → v0.1.6 Extract → v0.1.6 Normalize → Query Tokens
                                                    ↓
    DB → v0.1.7 Index Builder → v0.1.7 Normalize → Index Tokens
                                                    ↓
                                            n-gram Mismatch ✗
```

---

## Resolution Steps

### ✅ Step 1: Identify Correct Column Names
- Source: `docs/OCR_MATCH_CORE_IMPLEMENTATION.md`
- Supplier column: "供应单位名称"
- Project column: "单体工程名称"

### ✅ Step 2: Rebuild Index with v0.1.6 Code
```bash
# Ensure we're using rolled-back v0.1.6 code
git status  # Verify extractor.ts and label_alias.json are clean

# Ensure dist/ is built from v0.1.6 source
pnpm -F ./packages/ocr-match-core build

# Rebuild index with correct column names
node packages/ocr-match-core/dist/cli/build-index.js \
  --db data/db \
  --out runs/tmp/index.json \
  --config . \
  --field1 "供应单位名称" \
  --field2 "单体工程名称"
```

### ⏳ Step 3: Final Verification Test (IN PROGRESS)
```bash
node packages/ocr-match-core/dist/cli/match-ocr.js \
  --ocr data/ocr_txt \
  --index runs/tmp/index.json \
  --config . \
  --out "runs/run_v0.1.6_rollback_verify_final_$(date +%Y%m%d_%H%M)" \
  --autoPass 0.70 \
  --minFieldSim 0.60 \
  --minDeltaTop 0.03 \
  --log-level info
```

**Expected Result**: 71 exact, 25 review, 126 fail (32.0% auto-pass) - matching v0.1.6 baseline

---

## Lessons Learned

### 1. **Incomplete Rollback Procedure**
**What Went Wrong**: Only rolled back source code, forgot about compiled code and data files.

**Correct Procedure**:
1. Roll back source code (`git restore`)
2. **Rebuild compiled artifacts** (`pnpm build`)
3. **Check for corrupted data files** (index.json, cache, etc.)
4. Verify each component individually before full integration test

### 2. **Hidden Data File Dependencies**
**What Went Wrong**: Didn't realize index.json is tightly coupled to the code version that built it.

**Correct Understanding**:
- Index.json is NOT just data - it contains **normalized representations** of DB records
- Normalization logic is part of the code
- If normalization changes → index must be rebuilt
- Index files should be versioned or tagged with code version

### 3. **Default Parameter Assumptions**
**What Went Wrong**: Assumed build-index would auto-detect column names from Excel file.

**Correct Approach**:
- ALWAYS check CLI help/examples for required parameters
- Document column name mappings in configuration
- Consider creating a `db_schema.json` config file

### 4. **Test Data Provenance**
**What Went Wrong**: Lost track of when index.json was last rebuilt and with which code version.

**Best Practice**:
- Add metadata to index.json: `{"built_with_code_version": "v0.1.6", "built_at": "..."}`
- Keep backup of known-good indexes in versioned directories
- Consider adding index rebuild to automated test workflow

---

## Prevention Strategies

### Immediate Actions:
1. ✅ Add code version metadata to index.json structure
2. ✅ Document column mapping in `configs/v0.labs/10dae06c/db_schema.json`
3. ✅ Create backup of working index: `runs/tmp/index_v0.1.6_backup.json`

### Long-term Improvements:
1. Add index version check to match-ocr CLI (warn if index version ≠ code version)
2. Create automated test that rebuilds index and validates it produces consistent results
3. Add index rebuild to CI/CD pipeline for each code version
4. Consider storing index metadata separately from index data

---

## Status

**Current State**:
- ✅ Code rolled back to v0.1.6
- ✅ dist/ rebuilt from v0.1.6 source
- ✅ index.json rebuilt with v0.1.6 code and correct columns
- ⏳ Final verification test running (ID: b98362)

**Next Steps**:
1. Wait for verification test to complete (~35-40 minutes)
2. Compare results with v0.1.6 baseline (expected: 71 exact, 32.0%)
3. If successful, document resolution and close v0.1.7 incident
4. Create backup of working index
5. Implement prevention strategies

---

## File References

**Logs**:
- `/tmp/index_rebuild.log` - Failed first rebuild attempt
- `/tmp/index_rebuild_correct.log` - Successful rebuild with column names
- `/tmp/v0.1.6_final_verification.log` - Final verification test (running)

**Test Runs**:
- `runs/run_v0.1.6_full_20251113_214123/` - Baseline (71 exact, 32.0%)
- `runs/run_v0.1.6_rollback_verify_2_$(date +%Y%m%d_%H%M)/` - Failed verification with corrupted index
- `runs/run_v0.1.6_rollback_verify_final_$(date +%Y%m%d_%H%M)/` - Final verification with clean index (running)

**Code**:
- `packages/ocr-match-core/dist/cli/build-index.js:31-40` - Column name CLI options

**Documentation**:
- `docs/OCR_MATCH_CORE_IMPLEMENTATION.md` - Contains correct column mapping

---

**Report Status**: DRAFT - Will finalize after verification test completes
