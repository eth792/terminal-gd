# 失败原因深度分析报告

**生成时间**: 2025-11-12
**测试版本**: v0.1.3 (后处理清洗)
**样本来源**: runs/run_postprocess_20251112_231036/
**分析范围**: 5 个失败原因，每个抽样 5 个案例

---

## 失败原因分布（总览）

| 失败原因 | 数量 | 占比 | 优先级 |
|---------|-----|------|-------|
| **DELTA_TOO_SMALL** | 79 | 36.9% | 🔴 **最高** |
| **FIELD_SIM_LOW_PROJECT** | 56 | 26.2% | 🟠 高 |
| **FIELD_SIM_LOW_SUPPLIER** | 41 | 19.2% | 🟡 中 |
| **EXTRACT_EMPTY_PROJECT** | 18 | 8.4% | 🟢 中低 |
| **EXTRACT_BOTH_EMPTY** | 11 | 5.1% | 🟢 低 |

---

## 1. DELTA_TOO_SMALL（79 案例，36.9%）

### 问题本质
**Top1 与 Top2 候选分数差值 < 0.03**，系统无法判断哪个候选更准确，出于保守策略进入 review。

### 深度分析（5 个样本）

#### 案例 1: aibobaiyun4100962241.txt ⭐ **关键案例**

**提取结果**:
- q_supplier: `"艾博白云电气技术(扬州)有限公司"`
- q_project: `"武汉市轨道交通19号线工程鼓架山站10KV电力线路迁改工程"`

**Top1 候选**:
- cand_f1: `"艾博白云电气技术（扬州）有限公司"`
- cand_f2: `"武汉市轨道交通19号线工程鼓架山站10KV电力线路迁改工程"`
- s_field1: **0.7269** (因括号不同：`()` vs `（）`)
- s_field2: 1.0
- score: 0.8634

**根本原因**: **标点符号未归一化**
- OCR 识别出半角括号 `()`
- DB 中是全角括号 `（）`
- 导致字符串不完全匹配，相似度下降

#### 案例 2-5 分析汇总

| 案例 | 核心问题 | 相似度 | was_cleaned |
|-----|---------|-------|------------|
| andelijituanyouxiangongsi4100968520.txt | OCR: `"10油活"` vs DB: `"10kv"` | 0.9116 | ✅ YES |
| andelijituanyouxiangongsi4100968541.txt | OCR: `"洛线"` vs DB: `"沿线"`, `"金湖南"` vs `"金银湖南"` | 0.8298 | ✅ YES |
| baohuixianlan4100908540.txt | OCR: `"新建在出供中配态工理"` vs DB: `"新建住宅供电配套工程"` | 0.8692 | NO |
| baoshengkejichuangxingufenyouxiangongsi4100954930.txt | OCR: `"配"` vs DB: `"配套工程"` | 0.8658 | NO |

### 根本原因分类

| 原因 | 案例数 | 占比 | 可修复性 |
|-----|-------|------|---------|
| **标点符号未归一化** | 1/5 | 20% | ✅ 高（normalize 配置） |
| **OCR 识别错误** | 4/5 | 80% | ⚠️ 中（需 OCR 校正或容错） |

### 优化方案

#### ✅ 方案 1: 标点符号归一化（高 ROI）
**目标**: 将全角/半角标点统一

**实施**:
```json
// configs/v0.labs/f6b7160f/normalize.user.json
{
  "replacements": {
    "（": "(",
    "）": ")",
    "【": "[",
    "】": "]",
    "《": "<",
    "》": ">",
    "，": ",",
    "。": ".",
    "、": ",",
    "：": ":",
    "；": ";",
    "！": "!",
    "？": "?"
  }
}
```

**预期效果**:
- 修复 20% 的 DELTA_TOO_SMALL 案例（~16 个）
- 失败率下降 **7.2%**（16/222）

**成本**: 低（配置修改）

#### ⚠️ 方案 2: 降低 minDeltaTop 阈值（中 ROI）
**当前阈值**: 0.03（Top1 必须比 Top2 高 3%）
**建议阈值**: 0.02 或 0.015

**风险**: 可能引入更多误判（将错误候选判为 exact）

**预期效果**:
- 将 30-50% 的 DELTA_TOO_SMALL 转为 exact（~24-40 个）
- 需配合人工抽样验证准确率

**成本**: 低（配置修改）+ 中（需验证）

#### 🟡 方案 3: 字段级自适应阈值（中高 ROI，高成本）
**策略**:
- 供应商字段：要求 s_field1 ≥ 0.90（公司名必须精确）
- 工程名字段：放宽至 s_field2 ≥ 0.75（工程名变体较多）

**预期效果**: 平衡精确性与召回率

**成本**: 中（需重构 bucketize 逻辑）

---

## 2. FIELD_SIM_LOW_PROJECT（56 案例，26.2%）

### 问题本质
**工程名字段相似度 < 0.60**，提取的工程名与 DB 中的工程名差异过大。

### 深度分析（5 个样本）

#### 案例 1: baodingshiwuxingdianqi4100967040.txt

**提取结果**:
- q_project: `"武汉市润达房地产开发有限公司"居住、社会福利项目"`

**Top1 候选**:
- cand_f2: `"武汉发总实业有限公司"绿岛广场""`
- s_field2: **0.2215** ❌

**原因**: **提取的工程名与 DB 完全不匹配**（不同项目）

**判断**: 这是 **DB 召回失败**，而非 OCR 问题

#### 案例 2: baodingshiwuxingdianqiyouxiangongsi4100968568.txt ⭐ **后处理清洗案例**

**OCR 原文**:
```
报装编号：20171769-B
供应商：保定市五星电气有限公司20171769-B
工程名称：任公司(20171769)新住配完善工程
```

**提取结果（经清洗）**:
- q_supplier: `"保定市五星电气有限公司"` ✅ (清洗移除了 `"20171769-B"`)
- q_project: `"任公司(20171769)新住配完善工程"`

**Top1 候选**:
- cand_f2: `"武汉市武昌区华润橡树湾一期(20120011)新住配完善工程"`
- s_field2: **0.3428** ❌

**原因**: **工程名提取不完整**
- OCR 识别错误：`"任公司"` 应为某个完整公司名（如 `"武汉某某公司"`）
- `"任"` 字是 OCR 误识别

**判断**: **OCR 质量差** + **提取逻辑未能容错**

#### 案例 3-5 分析汇总

| 案例 | 核心问题 | s_field2 |
|-----|---------|----------|
| baoshengkejichuangxingufenyouxiangongsi4100912930.txt | 工程名过短：`"居住项目"` | 0.1369 |
| baoshengkejichuangxingufenyouxiangongsi4100931841.txt | 开发商名不同：`"武汉建卓置业"` vs `"武汉市坦达置业"` | 0.4760 |
| baoshengkejichuangxingufenyouxiangongsi4100965595.txt | OCR 识别错误：`"汉肉192号"` → `"汉口192号"` | 0.3847 |

### 根本原因分类

| 原因 | 案例数 | 占比 | 可修复性 |
|-----|-------|------|---------|
| **OCR 识别错误** | 3/5 | 60% | ⚠️ 中低（需高质量 OCR） |
| **提取不完整** | 1/5 | 20% | ✅ 中（改进 extract 逻辑） |
| **DB 召回失败** | 1/5 | 20% | 🔴 低（不同项目，无法匹配） |

### 优化方案

#### ✅ 方案 1: 改进 extract 拼接逻辑（中 ROI）
**问题**: 当 OCR 识别不完整时，extract 未能向下多行拼接

**建议**:
- 当工程名过短（< 10 字符）时，继续向下扫描 2-3 行
- 遇到关键词（如 `"新建"/"住宅"/"工程"`）则继续拼接

**预期效果**: 修复 ~20% 的 FIELD_SIM_LOW_PROJECT（~11 个）

**成本**: 中（需修改 extract 模块）

#### ⚠️ 方案 2: 模糊匹配容错（低 ROI，高成本）
**策略**:
- 对于工程名，允许更低的相似度阈值（如 0.50）
- 增加上下文匹配（开发商名 + 工程名联合判断）

**风险**: 误判率上升

**成本**: 高（需重构 match 和 bucketize 逻辑）

#### 🔴 方案 3: OCR 质量改进（高 ROI，高成本）
**根本解决方案**: 使用更高质量的 OCR 引擎

**建议**:
- 升级至 PaddleOCR（开源，精度更高）
- 对特定字段（公司名、工程名）进行后处理校正

**预期效果**: 修复 ~60% 的识别错误（~34 个）

**成本**: 高（需集成新 OCR 引擎）

---

## 3. FIELD_SIM_LOW_SUPPLIER（41 案例，19.2%）

### 问题本质
**供应商字段相似度 < 0.60**，OCR 识别的公司名与 DB 中的公司名完全不同。

### 深度分析（5 个样本）

#### 案例 1: baoshengkejichuangxingufenyouxiangongsi4100931553.txt ⭐ **OCR 误识别**

**OCR 原文**:
```
供应商：宝胜科技创新股份有限公司
```

**提取结果**:
- q_supplier: `"宝胜科技创新股份有限公司"`

**Top1 候选**:
- cand_f1: `"三变科技股份有限公司"` ❌
- s_field1: **0.5476**

**根本原因**: **公司名不同**
- OCR 识别的是 `"宝胜"`
- DB 中实际是 `"三变"`
- 这是 **DB 错误** 或 **OCR 误识别**

**判断**:
- 如果 OCR 图像清晰且为"宝胜"，则是 **DB 数据错误**
- 如果 OCR 图像模糊，则是 **OCR 识别错误**

#### 案例 2-5 分析汇总

| 案例 | q_supplier | cand_f1 | s_field1 | 原因 |
|-----|-----------|---------|----------|------|
| baohuixianlanjituan4100965990.txt | 宝辉线缆集团 | 泰亿达科技集团 | 0.4512 | 公司名不同 |
| baoshengkejichuangxingufenyouxiangongsi4100931561.txt | 宝胜科技创新 | 新能量科技 | 0.4916 | 公司名不同 |
| baoshengkejichuangxingufenyouxiangongsi4100962417.txt | 宝胜科技创折 | 中天科技海缆 | 0.5208 | OCR: `"折"` → `"新"` |
| beijingsifangjibaogongchengjishuyouxiangongsi4100862381.txt | A区新建住宅供电配套工程 | 武汉阿尔普智能电气 | 0.0384 | **提取完全失败** |

### 根本原因分类

| 原因 | 案例数 | 占比 | 可修复性 |
|-----|-------|------|---------|
| **公司名不同（DB 或 OCR 错误）** | 3/5 | 60% | 🔴 低（需人工核对） |
| **OCR 字符识别错误** | 1/5 | 20% | ⚠️ 中（需 OCR 改进） |
| **提取逻辑完全失败** | 1/5 | 20% | ✅ 高（后处理清洗已部分修复） |

### 优化方案

#### ✅ 方案 1: 扩展后处理清洗规则（高 ROI）
**当前问题**: 案例 5（`beijingsifangjibaogongchengjishuyouxiangongsi4100862381.txt`）提取结果为:
- q_supplier: `"A区新建住宅供电配套工程"` ❌（工程名误识别为供应商）

**改进**: 添加提取验证规则
- 如果供应商字段不包含 `"公司"/"集团"/"股份"` 等关键词，标记为提取失败
- 重新扫描 OCR 文本查找正确的供应商标签

**预期效果**: 修复 ~8 个提取失败案例（~20%）

**成本**: 低（在 postProcessFields 中添加验证）

#### 🔴 方案 2: 公司名模糊匹配（低 ROI，高成本）
**策略**:
- 建立公司名别名库（如 `"宝胜"` → `["宝胜科技", "三变科技"]`）
- 使用拼音或简称匹配

**风险**: 误匹配率高

**成本**: 高（需人工维护别名库）

#### 🟡 方案 3: 供应商字段专用 OCR 校正（中 ROI，中成本）
**策略**:
- 对供应商字段单独使用更高精度的 OCR 模型
- 与公司名数据库对比，纠正识别错误

**预期效果**: 修复 ~60% 的识别错误（~15 个）

**成本**: 中（需集成专用 OCR 或后处理模块）

---

## 4. EXTRACT_EMPTY_PROJECT（18 案例，8.4%）

### 问题本质
**工程名字段提取为空**，extract 阶段未能从 OCR 文本中找到工程名。

### 深度分析（5 个样本）

#### 案例 1: baoshengkejichuangxingufenyouxiangongsi4100964959.txt ⭐ **OCR 质量差**

**OCR 原文（关键行）**:
```
项目管理单位：客户服务中心市场及大客户服务室工程名称：
```

**问题**: **工程名称后面是空白**，OCR 未识别出任何内容

**判断**: **OCR 识别质量差**，图像可能模糊或缺失

#### 案例 2-5 分析汇总

| 案例 | q_supplier | q_project | 原因 |
|-----|-----------|-----------|------|
| hongliangdianlan4100931279.txt | `"SHPREATP联更人"` | 空 | OCR 完全失败（乱码） |
| huayuandianqi4100913356.txt | `"武汉华源电气设备有限责任公司"` ✅ | 空 | 工程名未识别 |
| hubeiediancuiyudianlan4100966472-b.txt | `"名称：湖北鄂电萃宇电缆有限公司"` | 空 | 标签前缀未清洗（`"名称："`） |
| hunanxianghejituandianlankejigufen4100925733.txt | `"司"` ❌ | 空 | 提取完全失败 |

### 根本原因分类

| 原因 | 案例数 | 占比 | 可修复性 |
|-----|-------|------|---------|
| **OCR 识别质量差（内容缺失）** | 4/5 | 80% | 🔴 低（需重新 OCR） |
| **提取逻辑未找到标签** | 1/5 | 20% | ⚠️ 中（扩展 label_alias） |

### 优化方案

#### ⚠️ 方案 1: OCR 质量检测与重试（中 ROI，高成本）
**策略**:
- 在 OCR 后检测关键字段是否为空
- 如果为空，调整 OCR 参数重新识别（如提高 DPI、增强对比度）

**预期效果**: 修复 ~50% 的识别缺失（~9 个）

**成本**: 高（需集成 OCR 质量检测 + 重试机制）

#### 🟡 方案 2: 扩展 label_alias（低 ROI）
**当前问题**: 案例 4 中，供应商标签为 `"名称："`，未被识别

**改进**:
```json
// configs/v0.labs/f6b7160f/label_alias.json
{
  "supplier": ["供应商", "供应商：", "名称", "名称：", "单位名称", "单位名称："]
}
```

**预期效果**: 修复 ~3 个标签变体案例（~20%）

**成本**: 低（配置修改）

#### 🔴 方案 3: 人工介入机制（最终方案）
**现实**: 80% 的 EXTRACT_EMPTY_PROJECT 是 OCR 质量问题，无法通过算法完全解决

**建议**:
- 对于提取为空的案例，自动标记为 `fail`（已实现）
- 提供人工补录接口，允许用户手动输入工程名

**成本**: 低（已有 fail 标记机制）

---

## 5. EXTRACT_BOTH_EMPTY（11 案例，5.1%）

### 问题本质
**供应商和工程名均为空**，extract 阶段完全失败。

### 深度分析（5 个样本）

#### 案例 1-4: jijijituanxinzhouhuaguang4100857939-*.txt ⭐ **文档类型不匹配**

**OCR 原文**:
```
协议库存订货通知单  2820936
协议供货单位：湖北济电力热团有限公司
项目分理门：客户服务中心市务及大客户服务室
项目实施单位：武汉获甸电力工冠有限公司
工名称  计划输号  报装编号  支付方式  序号  物料缩码  物料描述...
```

**根本原因**: **文档类型错误**
- 当前 extract 设计针对 **"到货验收单"**
- 该文档是 **"协议库存订货通知单"**（格式完全不同）
- 缺少 `"供应商："` 和 `"工程名称："` 标签

**判断**: **文档类型不在 scope 内**

#### 案例 5: shanghaishengxidianlikeji4100782923-a.txt

**OCR 原文**: （需查看，但根据结果推测同样是格式不匹配）

### 根本原因分类

| 原因 | 案例数 | 占比 | 可修复性 |
|-----|-------|------|---------|
| **文档类型不匹配** | 5/5 | 100% | ⚠️ 中（需扩展文档类型支持） |

### 优化方案

#### ✅ 方案 1: 文档类型检测（高 ROI）
**策略**:
- 在 extract 前检测文档类型（通过关键词）
- 支持的类型：
  - `"到货验收单"` → 当前逻辑
  - `"协议库存订货通知单"` → 新逻辑（提取 `"协议供货单位"` 和工程名）
- 不支持的类型：直接标记为 `UNSUPPORTED_DOC_TYPE`

**预期效果**:
- 修复 100% 的 EXTRACT_BOTH_EMPTY（11 个）
- 或正确标记为不支持类型，避免误判

**成本**: 中（需扩展 extract 模块支持多文档类型）

#### 🟡 方案 2: 文档过滤机制（短期方案）
**策略**:
- 在 OCR 阶段检测文档类型
- 对于不支持的类型，直接跳过处理

**预期效果**: 减少无效处理，提高整体效率

**成本**: 低（在 CLI 入口添加过滤）

---

## 总结与建议

### 失败原因根本分类

| 根本原因 | 影响案例数 | 占比 | 可修复性 | 优先级 |
|---------|-----------|------|---------|-------|
| **标点符号未归一化** | ~16 | 7.2% | ✅ **高** | 🔴 **P0** |
| **OCR 识别错误（字符级）** | ~60 | 27% | ⚠️ 中 | 🟠 P1 |
| **OCR 识别质量差（内容缺失）** | ~9 | 4% | 🔴 低 | 🟢 P3 |
| **提取逻辑不完善** | ~15 | 6.8% | ✅ 高 | 🟠 P1 |
| **文档类型不匹配** | ~11 | 5% | ⚠️ 中 | 🟡 P2 |
| **DB 数据错误/召回失败** | ~25 | 11.3% | 🔴 低 | 🟢 P3 |
| **阈值过严（DELTA_TOO_SMALL）** | ~79 | 35.6% | ✅ **高** | 🔴 **P0** |

### 优化方案优先级排序

#### 🔴 P0（立即实施，高 ROI）

**1. 标点符号归一化**
- **实施**: 修改 `normalize.user.json`，添加全角/半角标点转换规则
- **预期效果**: 修复 ~16 个 DELTA_TOO_SMALL（失败率 -7.2%）
- **成本**: 极低（配置文件修改）
- **风险**: 零

**2. 降低 minDeltaTop 阈值（需验证）**
- **实施**: 将 minDeltaTop 从 0.03 降至 0.02
- **预期效果**: 将 20-30 个 DELTA_TOO_SMALL 转为 exact（失败率 -9-13.5%）
- **成本**: 低（配置修改）+ 中（需人工验证准确率）
- **风险**: 中（可能引入误判）

---

#### 🟠 P1（短期实施，2-4 周）

**3. 扩展后处理清洗规则**
- **实施**: 在 `postProcessFields()` 中添加：
  - 供应商字段验证（必须包含"公司"/"集团"等）
  - 扩展公司后缀列表（"实业公司"/"工程公司"等）
- **预期效果**: 修复 ~10 个提取失败案例（失败率 -4.5%）
- **成本**: 低（代码修改 ~30 行）

**4. 改进 extract 拼接逻辑**
- **实施**: 当工程名过短（< 10 字符）时，继续向下扫描 2-3 行
- **预期效果**: 修复 ~11 个 FIELD_SIM_LOW_PROJECT（失败率 -5%）
- **成本**: 中（需修改 extract 模块）

**5. 扩展 label_alias**
- **实施**: 添加更多标签变体（如 `"名称："`）
- **预期效果**: 修复 ~3 个 EXTRACT_EMPTY（失败率 -1.4%）
- **成本**: 低（配置修改）

---

#### 🟡 P2（中期实施，1-2 月）

**6. 文档类型检测与多格式支持**
- **实施**: 扩展 extract 支持 "协议库存订货通知单"
- **预期效果**: 修复 11 个 EXTRACT_BOTH_EMPTY（失败率 -5%）
- **成本**: 中（需重构 extract 模块）

**7. 字段级自适应阈值**
- **实施**: 供应商要求 s_field1 ≥ 0.90，工程名放宽至 s_field2 ≥ 0.75
- **预期效果**: 平衡精确性与召回率
- **成本**: 中（需重构 bucketize 模块）

---

#### 🟢 P3（长期实施，3-6 月）

**8. OCR 质量改进**
- **实施**: 集成 PaddleOCR 或其他高精度 OCR 引擎
- **预期效果**: 修复 ~60 个 OCR 识别错误（失败率 -27%）
- **成本**: 高（需集成新引擎 + 性能优化）

**9. 供应商字段专用 OCR 校正**
- **实施**: 对供应商字段使用公司名数据库纠正
- **预期效果**: 修复 ~15 个 FIELD_SIM_LOW_SUPPLIER（失败率 -6.8%）
- **成本**: 中高（需维护公司名库）

---

### 预期总改进效果（实施 P0 + P1）

| 阶段 | 修复案例数 | 失败率变化 | 累计失败率 |
|------|-----------|-----------|-----------|
| **当前（v0.1.3）** | - | - | **60.8%** (135/222) |
| **+ P0 方案 1-2** | ~36-46 | -16.2% ~ -20.7% | **40.1% ~ 44.6%** |
| **+ P1 方案 3-5** | ~24 | -10.8% | **29.3% ~ 33.8%** |
| **目标（P0+P1 全部实施）** | ~60-70 | -27% ~ -31.5% | **~30% 失败率** ✅ |

### 下一步行动计划

**本周（Week 1）**:
1. ✅ 实施标点符号归一化（P0-1）
2. ⚠️ 实施 minDeltaTop 调整 + 抽样验证（P0-2）

**Week 2-3**:
3. 扩展后处理清洗规则（P1-3）
4. 扩展 label_alias（P1-5）

**Week 4-6**:
5. 改进 extract 拼接逻辑（P1-4）
6. 文档类型检测（P2-6）

**评估节点**: 每实施一个方案后，重新运行完整测试并更新实施记录。
