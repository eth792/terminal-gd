# v0.1.7 å®æ–½è®¡åˆ’ - å­—æ®µè¯­ä¹‰åŒ–é‡æ„

**åˆ›å»ºæ—¥æœŸ**: 2025-11-13
**è®¡åˆ’ç‰ˆæœ¬**: v1.0
**çŠ¶æ€**: â¸ï¸ å¾…å¯åŠ¨ï¼ˆv0.1.6 å®Œæˆåï¼‰
**è´Ÿè´£äºº**: Claude Code (Linus Mode)

---

## ğŸ“Š ç‰ˆæœ¬æ¦‚è§ˆ

### ç‰ˆæœ¬å®šä½

v0.1.7 = **å­—æ®µè¯­ä¹‰åŒ–é‡æ„** - ä»ç¨‹åºå‘˜å‹å¥½åˆ°ç”¨æˆ·å‹å¥½

**æ ¸å¿ƒç›®æ ‡**ï¼š
- ç”¨æˆ·çœ‹åˆ°çš„æ˜¯"ä¾›åº”å•†"ã€"å·¥ç¨‹åç§°"ã€"è®¢å•å·"ï¼Œè€Œä¸æ˜¯ `s_field1/s_field2`
- é…ç½®é©±åŠ¨çš„å­—æ®µæ˜ å°„ï¼ŒDB åˆ—åå˜åŒ–åªéœ€æ”¹é…ç½®
- ä¿æŒå‘åå…¼å®¹ï¼ˆæä¾› legacy modeï¼‰

**ä¸šåŠ¡ä»·å€¼**ï¼š
- âœ… æå‡å¯ç”¨æ€§ï¼šæ–°ç”¨æˆ·æ— éœ€"ç¿»è¯‘"æŠ€æœ¯æœ¯è¯­
- âœ… é™ä½ç»´æŠ¤æˆæœ¬ï¼šåˆ—åå˜åŒ–ä¸éœ€æ”¹ä»£ç 
- âœ… å¢å¼ºå¯æ‰©å±•æ€§ï¼šæœªæ¥æ–°å­—æ®µæ›´å®¹æ˜“æ·»åŠ 

---

## ğŸ¯ KPI ç›®æ ‡

| æŒ‡æ ‡ | v0.1.6 åŸºçº¿ | v0.1.7 ç›®æ ‡ | è¯´æ˜ |
|------|-------------|-------------|------|
| **è‡ªåŠ¨é€šè¿‡ç‡** | 34-36% | 34-36% | **ä¸å˜**ï¼ˆçº¯é‡æ„ï¼‰ |
| **ç”¨æˆ·ä½“éªŒ** | æŠ€æœ¯æœ¯è¯­ | ä¸šåŠ¡æœ¯è¯­ | æå‡å¯è¯»æ€§ |
| **ç»´æŠ¤æˆæœ¬** | ç¡¬ç¼–ç  | é…ç½®é©±åŠ¨ | é™ä½æœªæ¥ä¿®æ”¹æˆæœ¬ |

**é‡è¦**ï¼šè¿™æ˜¯çº¯é‡æ„ç‰ˆæœ¬ï¼Œä¸æ”¹å˜åŒ¹é…ç®—æ³•ï¼Œè‡ªåŠ¨é€šè¿‡ç‡åº”ä¿æŒä¸å˜ã€‚

---

## ğŸ—ºï¸ ä»»åŠ¡æ‹†è§£

### Phase 1: é…ç½®è®¾è®¡ï¼ˆ30 minï¼‰

#### Task 1.1: å®šä¹‰ field_schema.json ç»“æ„

**æ–°å¢é…ç½®æ–‡ä»¶**: `configs/v0.labs/<sha>/field_schema.json`

```json
{
  "version": "1.0",
  "output_mode": "semantic",  // "semantic" | "legacy"
  "fields": {
    "supplier": {
      "label": "ä¾›åº”å•†",
      "db_column": "ä¾›åº”å•ä½åç§°",
      "db_column_aliases": ["ä¾›åº”å•†", "ä¾›è´§å•ä½"],
      "ocr_labels": ["ä¾›åº”å•†", "ä¾›åº”å•ä½"],
      "description": "OCR æå–çš„ä¾›åº”å•†åç§°"
    },
    "project": {
      "label": "å·¥ç¨‹åç§°",
      "db_column": "å•ä½“å·¥ç¨‹åç§°",
      "db_column_aliases": ["é¡¹ç›®åç§°", "å·¥ç¨‹åç§°"],
      "ocr_labels": ["å·¥ç¨‹åç§°", "é¡¹ç›®åç§°"],
      "description": "OCR æå–çš„å·¥ç¨‹/é¡¹ç›®åç§°"
    },
    "order_id": {
      "label": "è®¢å•å·",
      "db_column": "æŠ¥è£…ç¼–å·",
      "db_column_aliases": ["è®¢å•å·", "ç¼–å·"],
      "description": "åŒ¹é…åˆ°çš„è®¢å•ç¼–å·ï¼ˆä¸»é”®ï¼‰"
    }
  }
}
```

**è®¾è®¡åŸåˆ™**ï¼š
- `label` - ç”¨æˆ·å¯è§çš„ä¸­æ–‡åç§°
- `db_column` - DB ä¸­çš„å®é™…åˆ—åï¼ˆä¸»åç§°ï¼‰
- `db_column_aliases` - DB åˆ—åçš„åˆ«åï¼ˆå¤„ç†ä¸åŒ Excel æ–‡ä»¶ï¼‰
- `ocr_labels` - OCR æå–æ—¶è¯†åˆ«çš„æ ‡ç­¾

---

### Phase 2: ä»£ç å®æ–½ï¼ˆ2 hrsï¼‰

#### Task 2.1: é…ç½®åŠ è½½å™¨æ‰©å±•

**æ–‡ä»¶**: `packages/ocr-match-core/src/config/loader.ts`

```typescript
interface FieldSchema {
  version: string;
  output_mode: 'semantic' | 'legacy';
  fields: {
    [key: string]: {
      label: string;
      db_column: string;
      db_column_aliases?: string[];
      ocr_labels?: string[];
      description?: string;
    };
  };
}

export interface Config {
  // ... ç°æœ‰å­—æ®µ ...
  fieldSchema: FieldSchema;
}
```

**å®æ–½è¦ç‚¹**ï¼š
- åŠ è½½ `field_schema.json`ï¼ˆå¿…éœ€æ–‡ä»¶ï¼‰
- éªŒè¯ schema ç»“æ„ï¼ˆZod schemaï¼‰
- é»˜è®¤ `output_mode: "semantic"`

---

#### Task 2.2: æå–å™¨æ”¹é€ 

**æ–‡ä»¶**: `packages/ocr-match-core/src/extract/extractor.ts`

**å½“å‰é€»è¾‘**ï¼ˆç¡¬ç¼–ç ï¼‰ï¼š
```typescript
const supplierLabels = ['ä¾›åº”å•†', 'ä¾›åº”å•ä½'];
const projectLabels = ['å·¥ç¨‹åç§°', 'é¡¹ç›®åç§°'];
```

**æ”¹ä¸º**ï¼ˆé…ç½®é©±åŠ¨ï¼‰ï¼š
```typescript
const supplierLabels = config.fieldSchema.fields.supplier.ocr_labels || [];
const projectLabels = config.fieldSchema.fields.project.ocr_labels || [];
```

---

#### Task 2.3: ç´¢å¼•æ„å»ºå™¨æ”¹é€ 

**æ–‡ä»¶**: `packages/ocr-match-core/src/indexer/builder.ts`

**å½“å‰é€»è¾‘**ï¼ˆç¡¬ç¼–ç æŸ¥æ‰¾ "ä¾›åº”å•ä½åç§°"ï¼‰ï¼š
```typescript
const supplierCol = findColumn(sheet, "ä¾›åº”å•ä½åç§°");
const projectCol = findColumn(sheet, "å•ä½“å·¥ç¨‹åç§°");
```

**æ”¹ä¸º**ï¼ˆæ”¯æŒåˆ«åï¼‰ï¼š
```typescript
const supplierCol = findColumnWithAliases(sheet,
  config.fieldSchema.fields.supplier.db_column,
  config.fieldSchema.fields.supplier.db_column_aliases
);
```

**æ–°å¢å‡½æ•°**ï¼š
```typescript
function findColumnWithAliases(
  sheet: any,
  primary: string,
  aliases: string[] = []
): number {
  for (const name of [primary, ...aliases]) {
    const col = findColumn(sheet, name);
    if (col !== -1) return col;
  }
  throw new Error(`Column not found: ${primary} (aliases: ${aliases.join(', ')})`);
}
```

---

#### Task 2.4: æŠ¥å‘Šç”Ÿæˆå™¨æ”¹é€ 

**æ–‡ä»¶**: `packages/ocr-match-core/src/report/csv.ts`

**å…³é”®ä¿®æ”¹**ï¼šCSV åˆ—åæ ¹æ® `output_mode` åŠ¨æ€ç”Ÿæˆ

```typescript
function getColumnHeaders(config: Config): string[] {
  if (config.fieldSchema.output_mode === 'legacy') {
    return ['file_name', 'q_supplier', 'q_project', 'cand_f1', 'cand_f2', 's_field1', 's_field2', ...];
  } else {
    return [
      'file_name',
      `OCR${config.fieldSchema.fields.supplier.label}`,
      `OCR${config.fieldSchema.fields.project.label}`,
      `åŒ¹é…${config.fieldSchema.fields.supplier.label}`,
      `åŒ¹é…${config.fieldSchema.fields.project.label}`,
      config.fieldSchema.fields.order_id.label,
      ...
    ];
  }
}
```

**è¾“å‡ºç¤ºä¾‹**ï¼ˆsemantic modeï¼‰ï¼š
```csv
file_name,OCRä¾›åº”å•†,OCRå·¥ç¨‹åç§°,åŒ¹é…ä¾›åº”å•†,åŒ¹é…å·¥ç¨‹åç§°,è®¢å•å·,source_file,row_index,...
xxx.txt,å®èƒœç§‘æŠ€,æ­¦æ±‰ä¸‰é•‡é¡¹ç›®,å®èƒœç§‘æŠ€åˆ›æ–°è‚¡ä»½æœ‰é™å…¬å¸,æ­¦æ±‰ä¸‰é•‡ä¸­å¿ƒç½®ä¸šé¡¹ç›®æ–°é…å¥—å·¥ç¨‹,20230163,ledger-1.xlsx,1288,...
```

---

### Phase 3: æµ‹è¯•éªŒè¯ï¼ˆ1 hrï¼‰

#### Task 3.1: å•å…ƒæµ‹è¯•
- [ ] `config/loader.ts` - field_schema åŠ è½½æµ‹è¯•
- [ ] `indexer/builder.ts` - åˆ—ååˆ«åæµ‹è¯•
- [ ] `report/csv.ts` - semantic/legacy æ¨¡å¼è¾“å‡ºæµ‹è¯•

#### Task 3.2: é›†æˆæµ‹è¯•ï¼ˆ10 æ ·æœ¬ï¼‰
- [ ] éªŒè¯ semantic mode è¾“å‡ºæ­£ç¡®
- [ ] éªŒè¯ legacy mode è¾“å‡ºä¸å˜
- [ ] éªŒè¯åˆ«åæœºåˆ¶å·¥ä½œï¼ˆåˆ›å»ºæµ‹è¯• Excel ä½¿ç”¨ä¸åŒåˆ—åï¼‰

#### Task 3.3: å›å½’æµ‹è¯•ï¼ˆ222 æ ·æœ¬ï¼‰
- [ ] è¿è¡Œå®Œæ•´æµ‹è¯•ï¼ˆsemantic modeï¼‰
- [ ] å¯¹æ¯” v0.1.6 ç»“æœï¼š
  - Exact/Review/Fail æ•°é‡åº”å®Œå…¨ä¸€è‡´
  - åŒ¹é…ç»“æœï¼ˆè®¢å•å·ï¼‰åº”å®Œå…¨ä¸€è‡´
  - åªæœ‰åˆ—åä¸åŒ

---

### Phase 4: æ–‡æ¡£æ›´æ–°ï¼ˆ30 minï¼‰

#### å¿…é¡»æ›´æ–°çš„æ–‡æ¡£
- [ ] `CLAUDE.md` - æ·»åŠ  field_schema.json è¯´æ˜
- [ ] `docs/implementation_record.md` - æ–°å¢ v0.1.7 æ¡ç›®
- [ ] `analysis/v0.1.7/migration_guide.md` - è¿ç§»æŒ‡å—ï¼ˆlegacy â†’ semanticï¼‰
- [ ] `analysis/v0.1.7/v0.1.7_å®æµ‹æŠ¥å‘Š.md` - æµ‹è¯•æŠ¥å‘Š

---

## ğŸ“… å®æ–½æ—¶é—´çº¿

**å‰ç½®æ¡ä»¶**: v0.1.6 å·²å®Œæˆå¹¶å‘å¸ƒ

### ç¬¬ 1 å¤©ï¼ˆv0.1.6 å®Œæˆå½“å¤©ï¼‰

**ä¸Šåˆ**ï¼ˆ2 hrsï¼‰:
- [ ] Phase 1: é…ç½®è®¾è®¡ï¼ˆ30 minï¼‰
- [ ] Phase 2: Task 2.1-2.2ï¼ˆä»£ç å®æ–½ 1 hrï¼‰
- [ ] Phase 2: Task 2.3ï¼ˆç´¢å¼•æ„å»ºå™¨æ”¹é€  30 minï¼‰

**ä¸‹åˆ**ï¼ˆ2 hrsï¼‰:
- [ ] Phase 2: Task 2.4ï¼ˆæŠ¥å‘Šç”Ÿæˆå™¨æ”¹é€  1 hrï¼‰
- [ ] Phase 3: Task 3.1-3.2ï¼ˆå•å…ƒæµ‹è¯• + 10 æ ·æœ¬æµ‹è¯• 1 hrï¼‰

### ç¬¬ 2 å¤©

**ä¸Šåˆ**ï¼ˆ1 hrï¼‰:
- [ ] Phase 3: Task 3.3ï¼ˆå®Œæ•´å›å½’æµ‹è¯• 30 minï¼‰
- [ ] åˆ†ææµ‹è¯•ç»“æœï¼Œç¡®è®¤æ— å›å½’ï¼ˆ30 minï¼‰

**ä¸‹åˆ**ï¼ˆ1 hrï¼‰:
- [ ] Phase 4: æ–‡æ¡£æ›´æ–°
- [ ] åˆ›å»º Git commit
- [ ] å‘å¸ƒ v0.1.7

**é¢„è®¡æ€»å·¥ä½œé‡**: 6 å°æ—¶ï¼ˆåˆ† 2 å¤©å®Œæˆï¼‰

---

## âš ï¸ é£é™©ç®¡ç†

### é«˜é£é™©é¡¹

#### 1. åŠŸèƒ½å›å½’
- **é£é™©**: åˆ—åé‡æ„å¯¼è‡´åŒ¹é…é€»è¾‘é”™è¯¯
- **ç¼“è§£**: å®Œæ•´å›å½’æµ‹è¯•ï¼ˆ222 æ ·æœ¬ï¼‰ï¼Œå¯¹æ¯” v0.1.6
- **éªŒè¯æ ‡å‡†**: Exact/Review/Fail åˆ†å¸ƒå®Œå…¨ä¸€è‡´

#### 2. DB åˆ—åä¸ä¸€è‡´
- **é£é™©**: ä¸åŒ Excel æ–‡ä»¶åˆ—åä¸åŒï¼Œå¯¼è‡´ç´¢å¼•æ„å»ºå¤±è´¥
- **ç¼“è§£**:
  - æ”¯æŒåˆ«åæœºåˆ¶
  - æä¾›æ¸…æ™°çš„é”™è¯¯æç¤ºï¼ˆ"æ‰¾ä¸åˆ°åˆ— Xï¼Œå·²å°è¯•åˆ«å Y, Z"ï¼‰
- **æµ‹è¯•**: åˆ›å»ºæµ‹è¯• Excel æ–‡ä»¶ä½¿ç”¨ä¸åŒåˆ—å

### ä¸­é£é™©é¡¹

#### 3. ä¸‹æ¸¸å·¥å…·å…¼å®¹æ€§
- **é£é™©**: å…¶ä»–å·¥å…·ä¾èµ– `s_field1` åˆ—å
- **ç¼“è§£**: æä¾› `output_mode: "legacy"` ä¿æŒå‘åå…¼å®¹
- **è¿ç§»è·¯å¾„**: é»˜è®¤ semanticï¼Œç”¨æˆ·å¯é€‰ legacy

---

## ğŸ¯ æˆåŠŸæ ‡å‡†

### å¿…é¡»è¾¾æˆï¼ˆP0ï¼‰

- âœ… å›å½’æµ‹è¯•é€šè¿‡ï¼šExact/Review/Fail åˆ†å¸ƒä¸ v0.1.6 ä¸€è‡´
- âœ… semantic mode è¾“å‡ºå¯è¯»åˆ—åï¼ˆ"OCRä¾›åº”å•†"ã€"åŒ¹é…å·¥ç¨‹åç§°"ç­‰ï¼‰
- âœ… legacy mode è¾“å‡ºä¸ v0.1.6 å®Œå…¨ä¸€è‡´
- âœ… ç´¢å¼•æ„å»ºæ”¯æŒåˆ—ååˆ«å

### æœŸæœ›è¾¾æˆï¼ˆP1ï¼‰

- âœ… æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- âœ… è¿ç§»æŒ‡å—å®Œæ•´æ¸…æ™°
- âœ… é”™è¯¯æç¤ºå‹å¥½ï¼ˆåˆ—åæ‰¾ä¸åˆ°æ—¶æç¤ºå°è¯•çš„åˆ«åï¼‰

---

## ğŸ“ äº¤ä»˜ç‰©æ¸…å•

### ä»£ç å˜æ›´

- [ ] `configs/v0.labs/<new_sha>/field_schema.json` - æ–°é…ç½®æ–‡ä»¶
- [ ] `packages/ocr-match-core/src/config/loader.ts` - åŠ è½½ field_schema
- [ ] `packages/ocr-match-core/src/extract/extractor.ts` - ä½¿ç”¨é…ç½®åŒ– ocr_labels
- [ ] `packages/ocr-match-core/src/indexer/builder.ts` - æ”¯æŒåˆ—ååˆ«å
- [ ] `packages/ocr-match-core/src/report/csv.ts` - åŠ¨æ€åˆ—åç”Ÿæˆ

### æ–‡æ¡£æ›´æ–°

- [ ] `analysis/v0.1.7/v0.1.7_å®æµ‹æŠ¥å‘Š.md` - å®Œæ•´æµ‹è¯•æŠ¥å‘Š
- [ ] `analysis/v0.1.7/migration_guide.md` - è¿ç§»æŒ‡å—
- [ ] `analysis/current/v0.1.7_plan.md` - æœ¬æ–‡ä»¶
- [ ] `docs/implementation_record.md` - æ–°å¢ v0.1.7 æ¡ç›®
- [ ] `docs/PROJECT_STATUS.md` - æ›´æ–°è·¯çº¿å›¾
- [ ] `CLAUDE.md` - æ›´æ–°å­—æ®µ schema è¯´æ˜

### è¿è¡Œäº§ç‰©

- [ ] `runs/run_v0.1.7_<timestamp>/` - å®Œæ•´è¿è¡ŒåŒ…ï¼ˆsemantic modeï¼‰
- [ ] `runs/run_v0.1.7_legacy_<timestamp>/` - legacy mode éªŒè¯åŒ…

---

## ğŸ”„ åç»­ç‰ˆæœ¬è§„åˆ’

### v0.1.8 (è®¡åˆ’ä¸­)

**é‡ç‚¹**:
- æ–‡æ¡£ç±»å‹æ£€æµ‹ï¼ˆè¯†åˆ«"è®¢è´§é€šçŸ¥å•" vs "éªŒæ”¶å•"ï¼‰
- åœ°å/æœ¯è¯­å½’ä¸€åŒ–å¢å¼º
- DB ç¼ºå¤±è®°å½•æœºåˆ¶ï¼ˆå¦‚æœ v0.1.6-v0.1.7 åä»æœ‰å¤§é‡ NO_CANDIDATESï¼‰

**é¢„æœŸæ—¶é—´**: 2-3 å¤©

---

## ğŸ’¡ è®¾è®¡å“²å­¦ï¼ˆLinus é£æ ¼ï¼‰

> "This is about making the output human-readable, not programmer-readable."
>
> "s_field1 is garbage. Call it what it is: ä¾›åº”å•†."
>
> "But don't break old code. Provide a legacy mode. Backward compatibility is sacred."
>
> "Configuration over code. DB column names will change, code shouldn't."

---

**æœ€åæ›´æ–°**: 2025-11-13 18:10
**çŠ¶æ€**: â¸ï¸ å¾…å¯åŠ¨ï¼ˆv0.1.6 å®Œæˆåç«‹å³å¼€å§‹ï¼‰
**é¢„è®¡å¼€å§‹æ—¶é—´**: v0.1.6 å‘å¸ƒåå½“å¤©
